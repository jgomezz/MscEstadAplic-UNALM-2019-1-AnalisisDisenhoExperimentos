---
title: "EjemploExperimentoFactorial"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read dataset
```{r }
abono1<-read.table("abono1.txt",header=T)
str(abono1)
```

## Transformation Factor
```{r }
rend<-abono1$rend
bloques<-as.factor(abono1$bloques)
dosis<-as.factor(abono1$dosis)
tipo<-as.factor(abono1$abono)
```


## Define model
```{r}
mod<-lm(rend~bloques+tipo+dosis+tipo*dosis)
```


# Disenho Factorial 2k

```{r echo=FALSE}
library(DoE.base)
fac.design(nlevels=c(2,2),factor.names=list(one=c(15,25),two=c(1,2)), replications=3)
```
```{r}
y   <- c(28,25,27,36,32,32,18,19,23,31,30,29)
A   <- rep(c(rep(-1,3),rep(1,3)),2)
B   <- c(rep(-1,6),rep(1,6))
AB  <- A*B
XA  <- data.frame(y,A)
XAp <- XA[XA$A==1,]
XAn <- XA[XA$A==-1,]
XAp
```

```{r}
XAn
```

```{r}
A <- mean(XAp$y)-mean(XAn$y) 
A
```
```{r} 
XB  <- data.frame(y,B)
XBp <- XB[XB$B==1,]
XBn <- XB[XB$B==-1,]
B <- mean(XBp$y)-mean(XBn$y)
B
```
Explicaci\'on : Pasar del nivel bajo al nivel alto de B el promedio es negativo, Se interpreta que el rendimiento promedio obtenido con el nivel alto de B es inferior al rendimiento promedio obtenido con el nivel bajo de B es 5 unidades. 

Si es positivo el rendimiento promedio del nivel alto de B es mayor al rendimiento promedio del nivel bajo de B.

```{r}
XAB <- data.frame(y,AB)
XABp <- XAB[XAB$AB==1,]
XABn <- XAB[XAB$AB==-1,]
contrasteAB <- sum(XABp$y)-sum(XABn$y) 
AB <- contrasteAB/(2*3)
AB
```

## Analisis de Varianza

Si p_value < 0.001, la prueba resulta muy altamente significativa, se rechaza $H_{0}$ y se denota con ***

$y=\beta_{0} + \beta_{1}*x_{1} + \beta_{2}*x_{2} + \beta_{12}*x_{1}*x_{2} +\epsilon$

x_i =  -1 si el factor de i se encuentra en el nivel bajo

x_i =   1 si el factor de i se encuentra en el nivel alto

i= 1 factor A, i = 20 factor B


Continuando con el ejemplo 6.1
-------------------------------
```{r}
y <- c(28,25,27,36,32,32,18,19,23,31,30,29)
A <- rep(c(rep(-1,3),rep(1,3)),2)
B <- c(rep(-1,6),rep(1,6))
mod <- lm(y~A+B+A*B)
```

Otra forma de encontrar los efectos estimados


```{r}
betaest <- coefficients(mod)
summary(betaest)
```
Mostrar los coeficientes de regresi\'on
```{r}
betaest
```


```{r}
efectosest <- 2*betaest[2:4]
data.frame(efectosest)
```
Reemplazando en el modelo

$\hat{\imath}$ = 8.333333 - 5.000000$x_1$ + 1.666667$x_2$	


```{r}
anva<-aov(mod)
summary(anva)
```



Se puede concluir que ambos efectos principales: concentración de reactivo y cantidad de catalizador influyen significativamente a un nivel del 1%. En cambio, La prueba de hipótesis sobre el efecto de la interacción (concentración de reactivo y cantidad de catalizador) resultó no significativa a un nivel del 10%.

Analisis de los errores de los residuales :
------------------------------------------
residuales studentizados
```{r}
mod1<-lm(y~A+B)
CME<-deviance(mod1)/df.residual(mod1)  
beta1<-coefficients(mod1)
I<-rep(1,length(y))
X<-cbind(I,A,B)
yest<-X%*%beta1
e<-y-yest
e
```
Otra manera de ver los residuales
```{r}
e1 <- residuals(mod1)
data.frame(e1)
```
Se obtiene los residuales studentizados
---------------------------------------
```{r}
H <- X%*%solve(t(X)%*%X)%*%t(X)
ri <- e/sqrt(CME*(1-diag(H)))
ri
```
Otra forma de encontrar los residuales studentizados
```{r}
ri <- rstandard(mod1)
data.frame(ri)
```

```{r}
par(mfrow=c(2,2))
plot(mod1)
```

```{r}
shapiro.test(ri)
```

```{r}
library(car)
ncvTest(mod1)
```


Gráfico de variabilidad de los residuales a nivel alto del factor versus la variabilidad de los residuos a nivel bajo, para el ejemplo 6.1
```{r}
ei <- residuals(mod1)
par(mfrow=c(2,1))
plot(A,ei)
plot(B,ei)

```
Grap 2 : La variabilidad para B- -1.0 es poco variable en la parte superior  y mas variable en la parte de abajo

Prueba de variabilidad
----------------------
Prueba de variabilidad de los residuales a nivel alto del factor versus la variabilidad de los residuos a nivel bajo:

$H_0: \sigma^2(i+)$

```{r}
dataA<-data.frame(ei,A)
dataAn<-dataA[dataA$A==-1,]
dataAn
```
```{r}
dataAp<-dataA[dataA$A==1,]
dataAp
```
Construyo la estadistica de prueba

```{r}
F<-log(var(dataAp$ei)/var(dataAn$ei)) 
F
```

```{r}
pvalue<-2*pnorm(F)
pvalue
```

No hay diferencia significativas entre la variabilidad del nivel alto y bajo de A

Para B 
------
```{r}
dataB<-data.frame(ei,B)
dataBn<-dataB[dataB$B==-1,]
dataBn
```
```{r}
dataBp<-dataB[dataB$B==1,]
dataBp
```

```{r}
F<-log(var(dataBp$ei)/var(dataBn$ei)) 
F
```

```{r}
pvalue<-2*(1-pnorm(F))
pvalue
```

## Gráfica de la superficie

```{r}
mod <- function(x1,x2){16.3333+0.83333*x1-5*x2}
x1 <- seq(15,25,0.5)
x2 <- seq(1,2,0.05)
z <- outer(x1,x2,mod)
persp(x1,x2,z,theta=-40,phi=30,ticktype="detailed",xlab="concentración del
reactivo",ylab="cantidad del catalizador", zlab="y")
```
```{r}
contour(x1,x2,z,nlevels=6,xlab="Concentración de reactivo", ylab="cantidad de
catalizador")
```

```{r}
A <- rep(c(-1,1),4)
B <- rep(c(rep(-1,2),rep(1,2)),2)
C <- c(rep(-1,4),rep(1,4))


#
y1 <- c(-3,0,-1,2,-1,2,1,6)
y2 <- c(-1,1,0,3,0,1,1,5)
y <- y1 + y2
ym <- c(y1,y2)

# Defino repiticiones
A1 <- rep(A,2)
B1 <- rep(B,2)
C1 <- rep(C,2)
```

Todo el modelo
```{r}
mod <- lm( y ~A*B*C)
summary(mod)
```

Todo el modelo
```{r}
mod <- lm( ym ~A1*B1*C1)
summary(mod)
```
Se muestran los efectos estimados
```{r}
betaest <- coefficients(mod)
efectoest <- 2*betaest[-1]
data.frame(efectoest)
```
```{r}
anva <- aov(mod)
summary(anva)
```
```{r}
y<-c(-3,0,-1,2,-1,2,1,6,-1,1,0,3,0,1,1,5)
  A<-rep(c(-1,1),8)
  B<-rep(c(-1,-1,1,1),4)
  C<-rep(c(rep(-1,4),rep(1,4)),2)
  datac<-data.frame(y,C)
  datacp<-datac[datac$C==1,]
  datacn<-datac[datac$C==-1,]
  ycn<-mean(datacn$y)
  ypp<-mean(datacp$y)
  nC<-c(-1,1)
  ypC<-c(ycn,ypp)
  plot(nC,ypC,type="l",xlab="C",ylab="media")
  interaction.plot(A,B,y)
```

Analisis de residuos

```{r}
y<-c(-3,0,-1,2,-1,2,1,6,-1,1,0,3,0,1,1,5)
  A<-rep(c(-1,1),8)
  B<-rep(c(-1,-1,1,1),4)
  C<-rep(c(rep(-1,4),rep(1,4)),2)
  mod<-lm(y~A*B*C)
  betaest<-coefficients(mod)
  betaest
```
```{r}
efectos<-2*betaest[2:8]
efectos
```

```{r}
par(mfrow=c(2,2))
plot(mod1)
```
```{r}
ri<-rstandard(mod1)
shapiro.test(ri)

```

```{r}
library(car)
ncvTest(mod1)
```
```{r}
A
B
C
```
```{r}
  ei<-residuals(mod1)
ei
```


```{r}
  ei<-residuals(mod1)
  par(mfrow=c(2,2))
  plot(A,ei)
  plot(B,ei)
  plot(C,ei)
  AB<-A*B
  plot(AB,ei)
```

##Ejemplo 6.2

Una sola réplica del diseño 24
Un producto químico se produce en un recipiente a presión. Se realiza un experimento factorial en la planta piloto para estudiar los efectos que se cree influyen sobre la taza de filtración de ese producto. Los cuatro factores son temperatura (A), presión (B), concentración de los reactivos (C) y rapidez de mezclado (D). Cada factor está presente en dos niveles; en la Tabla N° 7 y la Fig. N° 7 se muestran los datos recopilados de una sola réplica del experimento 24. Los 16 ensayos se realizaron en orden aleatorio. El ingeniero de proceso está interesado en maximizar la rapidez de filtración. Las condiciones actuales del proceso dan por resultado velocidad de filtración aproximadas de 75 gal/h. Además, en el proceso se utiliza actualmente el nivel alto del factor C, concentración de formaldehído. El ingeniero desearía reducir todo lo posible esta concentración, pero ha sido incapaz de hacerlo en virtud de que ello siempre ha dado por resultado menores velocidades de filtración.

Tabla N° 7: Datos del experimento del índice de filtración en la planta piloto


```{r}

``` 

